name: Build and Release Packages

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.2.1)'
        required: true
        default: '0.2.1'

env:
  CARGO_TERM_COLOR: always

jobs:
  build-rpm:
    name: Build RPM for ${{ matrix.os }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - os: centos8
            container: quay.io/centos/centos:stream8
            rpm_dist: el8
          - os: centos9
            container: quay.io/centos/centos:stream9
            rpm_dist: el9
    
    container:
      image: ${{ matrix.container }}
    
    steps:
      - name: Fix CentOS 8 repositories (if needed)
        run: |
          if [ -f /etc/centos-release ] && grep -q "CentOS Stream release 8" /etc/centos-release; then
            sed -i 's|mirrorlist=|#mirrorlist=|g' /etc/yum.repos.d/CentOS-*.repo
            sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-*.repo
            dnf clean all
          fi
          
      - name: Install dependencies
        run: |
          dnf install -y gcc gcc-c++ make cmake openssl-devel rpm-build rpmdevtools git
          
      - name: Install Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi
          
      - name: Setup RPM build environment
        run: |
          rpmdev-setuptree
          
      - name: Build binary
        run: |
          source $HOME/.cargo/env
          cargo build --release
          
      - name: Create RPM spec file
        run: |
          cp packaging/pingora-slice.spec.template ~/rpmbuild/SPECS/pingora-slice.spec
          sed -i "s/__VERSION__/${{ steps.get_version.outputs.VERSION }}/g" ~/rpmbuild/SPECS/pingora-slice.spec
          sed -i "s|__GITHUB_REPO__|${{ github.repository }}|g" ~/rpmbuild/SPECS/pingora-slice.spec
          sed -i "s|__BINARY_PATH__|$GITHUB_WORKSPACE/target/release/pingora-slice|g" ~/rpmbuild/SPECS/pingora-slice.spec
          sed -i "s|__CONFIG_PATH__|$GITHUB_WORKSPACE/examples/pingora_slice.yaml|g" ~/rpmbuild/SPECS/pingora-slice.spec
          sed -i "s|__README_PATH__|$GITHUB_WORKSPACE/README.md|g" ~/rpmbuild/SPECS/pingora-slice.spec
          sed -i "s|__README_ZH_PATH__|$GITHUB_WORKSPACE/README_zh.md|g" ~/rpmbuild/SPECS/pingora-slice.spec
          sed -i "s|__DATE__|$(date '+%a %b %d %Y')|g" ~/rpmbuild/SPECS/pingora-slice.spec
          
      - name: Build RPM
        run: |
          rpmbuild -bb ~/rpmbuild/SPECS/pingora-slice.spec
          
      - name: Find RPM file
        id: find_rpm
        run: |
          RPM_FILE=$(find ~/rpmbuild/RPMS -name "*.rpm" -type f)
          echo "rpm_file=$RPM_FILE" >> $GITHUB_OUTPUT
          echo "rpm_name=$(basename $RPM_FILE)" >> $GITHUB_OUTPUT
          
      - name: Upload RPM artifact
        uses: actions/upload-artifact@v4
        with:
          name: pingora-slice-${{ matrix.rpm_dist }}.rpm
          path: ${{ steps.find_rpm.outputs.rpm_file }}
          retention-days: 5

  build-deb:
    name: Build DEB for ${{ matrix.os }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - os: ubuntu-20.04
            codename: focal
          - os: ubuntu-22.04
            codename: jammy
          - os: debian-11
            codename: bullseye
          - os: debian-12
            codename: bookworm
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libssl-dev pkg-config dpkg-dev debhelper
          
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          
      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi
          
      - name: Build binary
        run: |
          cargo build --release
          strip target/release/pingora-slice
          
      - name: Create DEB package structure
        run: |
          mkdir -p debian-package/DEBIAN
          mkdir -p debian-package/usr/bin
          mkdir -p debian-package/etc/pingora-slice
          mkdir -p debian-package/var/cache/pingora-slice
          mkdir -p debian-package/var/log/pingora-slice
          mkdir -p debian-package/lib/systemd/system
          mkdir -p debian-package/usr/share/doc/pingora-slice
          
      - name: Copy files
        run: |
          cp target/release/pingora-slice debian-package/usr/bin/
          cp examples/pingora_slice.yaml debian-package/etc/pingora-slice/
          cp README.md debian-package/usr/share/doc/pingora-slice/
          cp README_zh.md debian-package/usr/share/doc/pingora-slice/
          
      - name: Create systemd service
        run: |
          cat > debian-package/lib/systemd/system/pingora-slice.service << 'EOF'
          [Unit]
          Description=Pingora Slice Proxy Server
          After=network.target
          
          [Service]
          Type=simple
          User=pingora-slice
          Group=pingora-slice
          ExecStart=/usr/bin/pingora-slice /etc/pingora-slice/pingora_slice.yaml
          Restart=on-failure
          RestartSec=5s
          
          # Security settings
          NoNewPrivileges=true
          PrivateTmp=true
          ProtectSystem=strict
          ProtectHome=true
          ReadWritePaths=/var/cache/pingora-slice /var/log/pingora-slice
          
          # Resource limits
          LimitNOFILE=65536
          LimitNPROC=4096
          
          [Install]
          WantedBy=multi-user.target
          EOF
          
      - name: Create control file
        run: |
          cat > debian-package/DEBIAN/control << EOF
          Package: pingora-slice
          Version: ${{ steps.get_version.outputs.VERSION }}
          Section: net
          Priority: optional
          Architecture: amd64
          Maintainer: Pingora Slice Team <noreply@github.com>
          Depends: libc6, libssl3 | libssl1.1
          Description: Pingora Slice Module - Automatic file slicing proxy
           Pingora Slice Module is a high-performance proxy module for Pingora
           that automatically splits large file requests into multiple Range
           requests, improving cache efficiency and reducing origin server load.
           .
           Features:
            - Automatic file slicing for large files
            - Concurrent subrequests for faster downloads
            - Intelligent cache management
            - Support for client Range requests
            - Complete error handling and retry mechanism
            - Prometheus metrics monitoring
          EOF
          
      - name: Create postinst script
        run: |
          cat > debian-package/DEBIAN/postinst << 'EOF'
          #!/bin/bash
          set -e
          
          # Create user and group
          if ! getent group pingora-slice >/dev/null 2>&1; then
              addgroup --system pingora-slice
          fi
          
          if ! getent passwd pingora-slice >/dev/null 2>&1; then
              adduser --system --ingroup pingora-slice --home /var/cache/pingora-slice \
                      --no-create-home --shell /usr/sbin/nologin \
                      --gecos "Pingora Slice service user" pingora-slice
          fi
          
          # Set permissions
          chown -R pingora-slice:pingora-slice /var/cache/pingora-slice 2>/dev/null || true
          chown -R pingora-slice:pingora-slice /var/log/pingora-slice 2>/dev/null || true
          
          # Reload systemd
          if [ -d /run/systemd/system ]; then
              systemctl daemon-reload >/dev/null 2>&1 || true
          fi
          
          echo "Pingora Slice has been installed successfully!"
          echo "Edit /etc/pingora-slice/pingora_slice.yaml to configure"
          echo "Start with: systemctl start pingora-slice"
          
          exit 0
          EOF
          chmod 755 debian-package/DEBIAN/postinst
          
      - name: Create prerm script
        run: |
          cat > debian-package/DEBIAN/prerm << 'EOF'
          #!/bin/bash
          set -e
          
          if [ -d /run/systemd/system ]; then
              systemctl stop pingora-slice >/dev/null 2>&1 || true
              systemctl disable pingora-slice >/dev/null 2>&1 || true
          fi
          
          exit 0
          EOF
          chmod 755 debian-package/DEBIAN/prerm
          
      - name: Create postrm script
        run: |
          cat > debian-package/DEBIAN/postrm << 'EOF'
          #!/bin/bash
          set -e
          
          if [ "$1" = "purge" ]; then
              # Remove user and group
              deluser pingora-slice >/dev/null 2>&1 || true
              delgroup pingora-slice >/dev/null 2>&1 || true
              
              # Remove data directories
              rm -rf /var/cache/pingora-slice
              rm -rf /var/log/pingora-slice
          fi
          
          if [ -d /run/systemd/system ]; then
              systemctl daemon-reload >/dev/null 2>&1 || true
          fi
          
          exit 0
          EOF
          chmod 755 debian-package/DEBIAN/postrm
          
      - name: Build DEB package
        run: |
          dpkg-deb --build debian-package pingora-slice_${{ steps.get_version.outputs.VERSION }}_${{ matrix.codename }}_amd64.deb
          
      - name: Upload DEB artifact
        uses: actions/upload-artifact@v4
        with:
          name: pingora-slice-${{ matrix.codename }}.deb
          path: pingora-slice_${{ steps.get_version.outputs.VERSION }}_${{ matrix.codename }}_amd64.deb
          retention-days: 5

  build-macos:
    name: Build macOS Package
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          
      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi
          
      - name: Build binary
        run: |
          cargo build --release
          strip target/release/pingora-slice
          
      - name: Create package structure
        run: |
          mkdir -p macos-package/usr/local/bin
          mkdir -p macos-package/usr/local/etc/pingora-slice
          mkdir -p macos-package/Library/LaunchDaemons
          
      - name: Copy files
        run: |
          cp target/release/pingora-slice macos-package/usr/local/bin/
          cp examples/pingora_slice.yaml macos-package/usr/local/etc/pingora-slice/
          
      - name: Create LaunchDaemon plist
        run: |
          cat > macos-package/Library/LaunchDaemons/com.pingora.slice.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>Label</key>
              <string>com.pingora.slice</string>
              <key>ProgramArguments</key>
              <array>
                  <string>/usr/local/bin/pingora-slice</string>
                  <string>/usr/local/etc/pingora-slice/pingora_slice.yaml</string>
              </array>
              <key>RunAtLoad</key>
              <false/>
              <key>KeepAlive</key>
              <true/>
              <key>StandardOutPath</key>
              <string>/usr/local/var/log/pingora-slice.log</string>
              <key>StandardErrorPath</key>
              <string>/usr/local/var/log/pingora-slice.error.log</string>
          </dict>
          </plist>
          EOF
          
      - name: Create tarball
        run: |
          cd macos-package
          tar czf ../pingora-slice-${{ steps.get_version.outputs.VERSION }}-macos-$(uname -m).tar.gz *
          cd ..
          
      - name: Create installation script
        run: |
          cat > install-macos.sh << 'EOF'
          #!/bin/bash
          set -e
          
          echo "Installing Pingora Slice..."
          
          # Extract files
          tar xzf pingora-slice-*.tar.gz -C /
          
          # Set permissions
          chmod +x /usr/local/bin/pingora-slice
          chmod 644 /Library/LaunchDaemons/com.pingora.slice.plist
          
          # Create log directory
          mkdir -p /usr/local/var/log
          
          echo "Installation complete!"
          echo ""
          echo "To start Pingora Slice:"
          echo "  sudo launchctl load /Library/LaunchDaemons/com.pingora.slice.plist"
          echo ""
          echo "To stop Pingora Slice:"
          echo "  sudo launchctl unload /Library/LaunchDaemons/com.pingora.slice.plist"
          echo ""
          echo "Configuration file: /usr/local/etc/pingora-slice/pingora_slice.yaml"
          EOF
          chmod +x install-macos.sh
          
      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: pingora-slice-macos
          path: |
            pingora-slice-${{ steps.get_version.outputs.VERSION }}-macos-*.tar.gz
            install-macos.sh
          retention-days: 5

  create-release:
    name: Create GitHub Release
    needs: [build-rpm, build-deb, build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "TAG=v${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
            echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi
          
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          
      - name: Display structure of downloaded files
        run: ls -R ./artifacts
        
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.get_version.outputs.TAG }}
          release_name: Release ${{ steps.get_version.outputs.VERSION }}
          body: |
            ## Pingora Slice v${{ steps.get_version.outputs.VERSION }}
            
            ### ðŸ“¦ Installation
            
            #### RPM (CentOS/Rocky/AlmaLinux)
            
            **CentOS 8 / Rocky Linux 8 / AlmaLinux 8:**
            ```bash
            sudo dnf install -y ./pingora-slice-${{ steps.get_version.outputs.VERSION }}-1.el8.x86_64.rpm
            ```
            
            **CentOS 9 / Rocky Linux 9 / AlmaLinux 9:**
            ```bash
            sudo dnf install -y ./pingora-slice-${{ steps.get_version.outputs.VERSION }}-1.el9.x86_64.rpm
            ```
            
            #### DEB (Ubuntu/Debian)
            
            **Ubuntu 20.04 (Focal):**
            ```bash
            sudo dpkg -i pingora-slice_${{ steps.get_version.outputs.VERSION }}_focal_amd64.deb
            sudo apt-get install -f
            ```
            
            **Ubuntu 22.04 (Jammy):**
            ```bash
            sudo dpkg -i pingora-slice_${{ steps.get_version.outputs.VERSION }}_jammy_amd64.deb
            sudo apt-get install -f
            ```
            
            **Debian 11 (Bullseye):**
            ```bash
            sudo dpkg -i pingora-slice_${{ steps.get_version.outputs.VERSION }}_bullseye_amd64.deb
            sudo apt-get install -f
            ```
            
            **Debian 12 (Bookworm):**
            ```bash
            sudo dpkg -i pingora-slice_${{ steps.get_version.outputs.VERSION }}_bookworm_amd64.deb
            sudo apt-get install -f
            ```
            
            #### macOS
            
            ```bash
            tar xzf pingora-slice-${{ steps.get_version.outputs.VERSION }}-macos-*.tar.gz
            sudo bash install-macos.sh
            ```
            
            ### ðŸš€ Quick Start
            
            **Linux (systemd):**
            ```bash
            # Edit configuration
            sudo vi /etc/pingora-slice/pingora_slice.yaml
            
            # Start service
            sudo systemctl start pingora-slice
            sudo systemctl enable pingora-slice
            
            # Check status
            sudo systemctl status pingora-slice
            ```
            
            **macOS:**
            ```bash
            # Edit configuration
            sudo vi /usr/local/etc/pingora-slice/pingora_slice.yaml
            
            # Start service
            sudo launchctl load /Library/LaunchDaemons/com.pingora.slice.plist
            
            # Check logs
            tail -f /usr/local/var/log/pingora-slice.log
            ```
            
            ### âœ¨ Features
            
            - âœ… Two-tier cache system (L1 memory + L2 disk)
            - âœ… HTTP PURGE support for cache invalidation
            - âœ… Automatic file slicing for large files
            - âœ… Concurrent subrequests for faster downloads
            - âœ… Intelligent cache management
            - âœ… Support for client Range requests
            - âœ… Complete error handling and retry mechanism
            - âœ… Prometheus metrics monitoring
            
            ### ðŸ“š Documentation
            
            - [README](https://github.com/${{ github.repository }}/blob/main/README.md)
            - [ä¸­æ–‡æ–‡æ¡£](https://github.com/${{ github.repository }}/blob/main/README_zh.md)
            - [Configuration Guide](https://github.com/${{ github.repository }}/blob/main/docs/CONFIGURATION.md)
            - [Deployment Guide](https://github.com/${{ github.repository }}/blob/main/docs/DEPLOYMENT.md)
            - [HTTP PURGE Reference](https://github.com/${{ github.repository }}/blob/main/docs/HTTP_PURGE_REFERENCE.md)
          draft: false
          prerelease: false
          
      - name: Upload RPM packages
        run: |
          for rpm in ./artifacts/pingora-slice-el*.rpm/*.rpm; do
            filename=$(basename "$rpm")
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/x-rpm" \
              --data-binary @"$rpm" \
              "${{ steps.create_release.outputs.upload_url }}?name=$filename"
          done
          
      - name: Upload DEB packages
        run: |
          for deb in ./artifacts/pingora-slice-*.deb/*.deb; do
            filename=$(basename "$deb")
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/vnd.debian.binary-package" \
              --data-binary @"$deb" \
              "${{ steps.create_release.outputs.upload_url }}?name=$filename"
          done
          
      - name: Upload macOS packages
        run: |
          for file in ./artifacts/pingora-slice-macos/*; do
            filename=$(basename "$file")
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/gzip" \
              --data-binary @"$file" \
              "${{ steps.create_release.outputs.upload_url }}?name=$filename"
          done
